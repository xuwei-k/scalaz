# Use Docker-based container (instead of OpenVZ)
sudo: false

cache:
  directories:
    - $HOME/.ivy2/cache

language: scala
scala:
  - 2.12.2
  - 2.11.11
jdk:
  - oraclejdk8 # scalaz 7.3 does not support Java 7

script:
  - git config core.whitespace tab-in-indent,trailing-space,blank-at-eol
  - git show --oneline --check
  - sbt ++$TRAVIS_SCALA_VERSION -J-Xmx3784m check-gen-type-classes "project $TEST_PROJECT" test:compile
  - sbt ++$TRAVIS_SCALA_VERSION "project $TEST_PROJECT" test "project /" $(if [[ "${TEST_PROJECT}" == "rootJVM" ]]; then echo "publish" ; fi)
  # Tricks to avoid unnecessary cache updates
  - find $HOME/.sbt -name "*.lock" | xargs rm
  - find $HOME/.ivy2 -name "ivydata-*.properties" | xargs rm

env:
  matrix:
  - TEST_PROJECT="rootJVM"
  - TEST_PROJECT="rootJS"
  global:
  - secure: "KrEcY0bltQh5kMn/hyiuGDZKvnU8SpQGGxUJJ4GnZyxNSYNfYI12acE81fDAMAnVV0gJaErBhyfm1OrThRm0633TBthseFWLouI2blikqSdsAM27kx3LVmRk9qlNnUfMIymCzSnpA155++x9VK/a9uzo+XzCdjl4MDq0C7Sugsp9RychPWGObz/54YbDn9/gRgqmG3h8HafJDcCZxUvvZOmck9fhTbHTYZmpxnW2jIdAPlh53GsIjSr6cHFR7nmHFRieoVl7oo/uaZOU6aEueE50yDNDFE4xwn7ngJr8TEzK+KvnThbmkDyHGtwyWG8PvtghK8mlPihB5hk6OWvYFTixRzSrpvGEXq8fpWmPP6Yh0G+/iXjD/CKoTxKBRdkC6+06MpZ/i+mqv2LCs2RFlyN7YNKJvjRabNpxJO0avdcYG0GKqVdapUBbvPfpBuiAjOAIPpwu2b9YcbkLONPNmnxpk6QOyk1inEFWaRF7xwxnMeuaHwPxsyNfDJiEx21dVYZqrtiKbjbUnmzHuX7ODqIFMVyZQENvA2FHB/kIX/+fWwdx/XOQQZ5YAtOSiYt8FoeuT3xaA797mM2rFKmUf44mdKyNBxGtT62SWnUtqxYHrdEdjEv+b2Q53BCrz9qHzpuwmqi7KB3Cllb1aJ8sHdDcK1HPSvRzvXbFHOrxsQg="
  - secure: "JmSzU69UYLXa4vQRCfUwyMRRzMkG0PsIi33h/P4WgaRcs5rz6VbhrhTHF+tVsvB028DrWmLdSWfKHx3oJqvQvPJ+9CW+P2yL44CEGEqRnTbQ7n0odarIgnx4HiIqTQxQIMwJPlLzBnpXagtYtGYPpPSbIrdrzqiJfIQ+BzB69BTt1BsnCiBSskkYChS5bDn2JQUGJrAgdHzvaSEtv33RGeTtTbcXcP5v1ivkFQzt8YHaZ2ahmrOCjQ2GiNODSAkTQgWpE47ihvM/rkqKqRga/Jt5Tfb4AxrAodY2wSSmJAbTwtjEoS5Be45iSuQuReQCAsbtDFDNw99P/AecIM2vI6XlJXAxXKi4DHTG9hcP/uZF2Y68gJoclmdn79cOKu/++x+dBSJkCh+vOrAUQYn+ind9/fBM6Dv/46Kl2m9H+goFmdqhg6Qg226Akz6+w4eaU5wMFPFDmozTbFQkD8b6sA+ywsrvrgwJ/7pZ4mkOjE7nmt7pfJHAOia3qZGpVhsfs4UTlYsRTq9HEoztBF3IAs2yQziwUEBjDrCwIEybVH2Z20gQPOs07ZHsTP1lm/RNy27gfx0k/16ryYIrctPH2s8yAKPWB0kuZubA8vdfGeeZ+G+cRoKYjr52ZQ8ZDMvvmsbiEYEnAPYAfIkQPyn8lK7y0wyFo3NgEZul+Wawq9M="

addons:
  apt:
    packages:
      - oracle-java8-installer

matrix:
  include:
  - scala: 2.13.0-M1
    jdk: oraclejdk8
    env: TEST_PROJECT="rootJVM"
    script:
    # https://github.com/non/kind-projector/issues/50
    - git clone https://github.com/non/kind-projector.git
    - cd kind-projector
    - git checkout v0.9.3
    - sbt ++${TRAVIS_SCALA_VERSION} 'set scalacOptions -= "-Xfatal-warnings"' publishLocal
    - cd ..
    - sbt ++${TRAVIS_SCALA_VERSION} -J-Xmx3784m check-gen-type-classes "project $TEST_PROJECT" test publish
  - scala: 2.13.0-M1
    jdk: oraclejdk8
    env: TEST_PROJECT="rootJS"
    script:
    # https://github.com/non/kind-projector/issues/50
    - git clone https://github.com/non/kind-projector.git
    - cd kind-projector
    - git checkout v0.9.3
    - sbt ++${TRAVIS_SCALA_VERSION} 'set scalacOptions -= "-Xfatal-warnings"' publishLocal
    - cd ..
    # https://github.com/rickynils/scalacheck/issues/330
    - sbt ++${TRAVIS_SCALA_VERSION} -J-Xmx3784m check-gen-type-classes coreJS/compile effectJS/compile iterateeJS/compile coreJS/publish effectJS/publish iterateeJS/publish
  - scala: 2.11.11
    jdk: oraclejdk8
    sudo: required
    before_install:
    - sudo apt-get -qq update
    - sudo sh -c "echo 'deb http://llvm.org/apt/precise/ llvm-toolchain-precise-3.7 main' >> /etc/apt/sources.list"
    - sudo sh -c "echo 'deb http://llvm.org/apt/precise/ llvm-toolchain-precise main' >> /etc/apt/sources.list"
    - wget -O - http://llvm.org/apt/llvm-snapshot.gpg.key | sudo apt-key add -
    - sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test
    - sudo apt-get -qq update
    - sudo apt-get install -y libgc-dev clang++-3.7 llvm-3.7 llvm-3.7-dev llvm-3.7-runtime llvm-3.7-tool libunwind7-dev
    # Install re2
    # https://github.com/scala-native/scala-native/commit/1d312519788534ff41477e4d7f758a6e7451be05#diff-354f30a63fb0907d4ad57269548329e3R28
    - sudo apt-get install -y make
    - export CXX=clang++-3.7
    - git clone https://code.googlesource.com/re2
    - pushd re2
    - git checkout 2017-03-01
    - make -j4 test
    - sudo make install prefix=/usr
    - make testinstall prefix=/usr
    - popd
    script:
    - ./sbt ++$TRAVIS_SCALA_VERSION nativeTest/run coreNative/publish effectNative/publish iterateeNative/publish

  - dist: trusty
    group: edge
    sudo: required
    scala: 2.12.2
    jdk: oraclejdk9
    script:
    # https://github.com/sbt/sbt/pull/2951
    - git clone https://github.com/retronym/java9-rt-export
    - cd java9-rt-export/
    - git checkout 1019a2873d057dd7214f4135e84283695728395d
    - jdk_switcher use oraclejdk8
    - sbt package
    - jdk_switcher use oraclejdk9
    - mkdir -p $HOME/.sbt/0.13/java9-rt-ext; java -jar target/java9-rt-export-*.jar $HOME/.sbt/0.13/java9-rt-ext/rt.jar
    - jar tf $HOME/.sbt/0.13/java9-rt-ext/rt.jar | grep java/lang/Object
    - cd ..
    - ./sbt -Dscala.ext.dirs=$HOME/.sbt/0.13/java9-rt-ext ++$TRAVIS_SCALA_VERSION -J-Xmx3784m check-gen-type-classes rootJVM/test rootJS/test
